<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Venus nv21 Upgrade Guide | Venus Filecoin</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/assets/venus-logo.png">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-SMSDTMGLTV"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SMSDTMGLTV');</script>
    <meta name="description" content="Venus is a Go implementation of the Filecoin Distributed Storage Network.">
    
    <link rel="preload" href="/assets/css/0.styles.70d1da1f.css" as="style"><link rel="preload" href="/assets/js/app.cc17245a.js" as="script"><link rel="preload" href="/assets/js/2.0bbd4042.js" as="script"><link rel="preload" href="/assets/js/35.d6ee49fe.js" as="script"><link rel="prefetch" href="/assets/js/10.f0629376.js"><link rel="prefetch" href="/assets/js/11.f97206d7.js"><link rel="prefetch" href="/assets/js/12.22497a30.js"><link rel="prefetch" href="/assets/js/13.683343d6.js"><link rel="prefetch" href="/assets/js/14.1bc0fc37.js"><link rel="prefetch" href="/assets/js/15.2770a953.js"><link rel="prefetch" href="/assets/js/16.d869f1e9.js"><link rel="prefetch" href="/assets/js/17.d0f11ffb.js"><link rel="prefetch" href="/assets/js/18.12917fcb.js"><link rel="prefetch" href="/assets/js/19.00c21b62.js"><link rel="prefetch" href="/assets/js/20.6f5ead3f.js"><link rel="prefetch" href="/assets/js/21.846a0b51.js"><link rel="prefetch" href="/assets/js/22.f15c4ba3.js"><link rel="prefetch" href="/assets/js/23.09d8a9a8.js"><link rel="prefetch" href="/assets/js/24.5b92c5bd.js"><link rel="prefetch" href="/assets/js/25.4a2e53d4.js"><link rel="prefetch" href="/assets/js/26.b79cdbaa.js"><link rel="prefetch" href="/assets/js/27.c1a394dd.js"><link rel="prefetch" href="/assets/js/28.ae02dd6f.js"><link rel="prefetch" href="/assets/js/29.350338c7.js"><link rel="prefetch" href="/assets/js/3.dfc609c3.js"><link rel="prefetch" href="/assets/js/30.f9819710.js"><link rel="prefetch" href="/assets/js/31.cc5663af.js"><link rel="prefetch" href="/assets/js/32.b7e9f209.js"><link rel="prefetch" href="/assets/js/33.744bc253.js"><link rel="prefetch" href="/assets/js/34.6e235e33.js"><link rel="prefetch" href="/assets/js/36.84abfa94.js"><link rel="prefetch" href="/assets/js/37.6e38a0f3.js"><link rel="prefetch" href="/assets/js/38.bf5aa34b.js"><link rel="prefetch" href="/assets/js/39.918ef1f6.js"><link rel="prefetch" href="/assets/js/4.506518be.js"><link rel="prefetch" href="/assets/js/40.f082c474.js"><link rel="prefetch" href="/assets/js/41.5b0bb583.js"><link rel="prefetch" href="/assets/js/42.3707eb07.js"><link rel="prefetch" href="/assets/js/43.5464da8f.js"><link rel="prefetch" href="/assets/js/44.6010d4b3.js"><link rel="prefetch" href="/assets/js/45.3927d2d7.js"><link rel="prefetch" href="/assets/js/46.1ee199a8.js"><link rel="prefetch" href="/assets/js/47.004c48b8.js"><link rel="prefetch" href="/assets/js/48.124172df.js"><link rel="prefetch" href="/assets/js/49.089df6a1.js"><link rel="prefetch" href="/assets/js/5.34e2ab1e.js"><link rel="prefetch" href="/assets/js/50.70978d8c.js"><link rel="prefetch" href="/assets/js/51.1b9d3267.js"><link rel="prefetch" href="/assets/js/52.7be06f34.js"><link rel="prefetch" href="/assets/js/53.05871764.js"><link rel="prefetch" href="/assets/js/54.b614f89a.js"><link rel="prefetch" href="/assets/js/55.b5e70209.js"><link rel="prefetch" href="/assets/js/56.d4acaa4e.js"><link rel="prefetch" href="/assets/js/57.9f3cefcd.js"><link rel="prefetch" href="/assets/js/58.bdfb0b74.js"><link rel="prefetch" href="/assets/js/59.df859ebc.js"><link rel="prefetch" href="/assets/js/6.14585a82.js"><link rel="prefetch" href="/assets/js/60.8135b1c5.js"><link rel="prefetch" href="/assets/js/7.16dc2982.js"><link rel="prefetch" href="/assets/js/8.0f750869.js"><link rel="prefetch" href="/assets/js/9.f2fc0f61.js">
    <link rel="stylesheet" href="/assets/css/0.styles.70d1da1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/venus-logo-title.svg" alt="Venus Filecoin" class="logo"> <span class="site-name can-hide">Venus Filecoin</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/intro/" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/operation/" class="nav-link router-link-active">
  Deployment &amp; Operation
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/operation/nv21-upgrade.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/nv21-upgrade.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/intro/" class="nav-link">
  Introduction
</a></div><div class="nav-item"><a href="/operation/" class="nav-link router-link-active">
  Deployment &amp; Operation
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/operation/nv21-upgrade.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/operation/nv21-upgrade.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Deployment</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/operation/" aria-current="page" class="sidebar-link">Deployment of a Venus system</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Network Upgrade</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/operation/nv22-upgrade.html" class="sidebar-link">nv22 upgrade</a></li><li><a href="/operation/nv21-upgrade.html" aria-current="page" class="active sidebar-link">nv21 upgrade</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/operation/nv21-upgrade.html#precautions" class="sidebar-link">Precautions</a></li><li class="sidebar-sub-header"><a href="/operation/nv21-upgrade.html#products-upgrade-guide" class="sidebar-link">Products Upgrade Guide</a></li></ul></li><li><a href="/operation/nv19-upgrade.html" class="sidebar-link">nv19 upgrade</a></li><li><a href="/operation/nv18-upgrade.html" class="sidebar-link">nv18 upgrade</a></li><li><a href="/operation/nv17-upgrade.html" class="sidebar-link">nv17 upgrade</a></li><li><a href="/operation/nv16-upgrade.html" class="sidebar-link">nv16 upgrade</a></li><li><a href="/operation/nv15-upgrade.html" class="sidebar-link">nv15 upgrade</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="venus-nv21-upgrade-guide"><a href="#venus-nv21-upgrade-guide" class="header-anchor">#</a> Venus nv21 Upgrade Guide</h1> <h2 id="precautions"><a href="#precautions" class="header-anchor">#</a> Precautions</h2> <ol><li>Be sure to upgrade all Venus products</li> <li>After upgrading, please use the <code>curl</code> command to call the <code>Version</code> API to check the version number. Details of each Venus products' version interface can be found <a href="https://github.com/filecoin-project/venus/issues/5132" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Monitor proper on-chain of pre and prove messages</li> <li>Monitor proper on-chain of window post messages</li> <li>Monitor block producing</li> <li>Check whether the gas fee related settings are in effect</li></ol> <h2 id="products-upgrade-guide"><a href="#products-upgrade-guide" class="header-anchor">#</a> Products Upgrade Guide</h2> <table><thead><tr><th>Product</th> <th>tag</th> <th>commit</th></tr></thead> <tbody><tr><td>sophon-auth</td> <td>v1.14.0</td> <td>7caadbc</td></tr> <tr><td>venus</td> <td>v1.14.2</td> <td>9204048</td></tr> <tr><td>sophon-messager</td> <td>v1.14.0</td> <td>e5f8371</td></tr> <tr><td>soohon-gateway</td> <td>v1.14.0</td> <td>1adf038</td></tr> <tr><td>venus-wallet</td> <td>v1.14.0</td> <td>b478cd0</td></tr> <tr><td>sophon-miner</td> <td>v1.14.0</td> <td>9ca976c</td></tr> <tr><td>droplet</td> <td>v2.10.0</td> <td>6daf168</td></tr> <tr><td>damocles-manager</td> <td>v0.9.2</td> <td>f3c5400</td></tr> <tr><td>damocles-worker</td> <td>v0.9.2</td> <td>f3c5400</td></tr></tbody></table> <h3 id="recommended-upgrade-sequence"><a href="#recommended-upgrade-sequence" class="header-anchor">#</a> Recommended Upgrade Sequence</h3> <ol><li>sophon-auth</li> <li>venus</li> <li>soohon-gateway</li> <li>sophon-messager</li> <li>sophon-miner</li> <li>droplet</li> <li>venus-wallet</li> <li>damocles-manager
9.damocles-worker</li></ol> <h3 id="sophon-auth"><a href="#sophon-auth" class="header-anchor">#</a> sophon-auth</h3> <p>Affected functions:</p> <ul><li>Affecting how other Venus products are authorized to use the sophon service</li></ul> <p>Dependency:</p> <ul><li>None</li></ul> <p>Precautions:</p> <ul><li>Check if authentication is normal after startup</li></ul> <h3 id="venus"><a href="#venus" class="header-anchor">#</a> venus</h3> <p>Affected functions:</p> <ul><li>None</li></ul> <p>Dependency:</p> <ul><li>sophon-auth</li></ul> <p>Precautions:</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Compile: First <code>make dist-clean</code> and then <code>make</code>, this can prevent problems caused by failure to upgrade <code>filecoin-ffi</code> properly</p> <p><strong>If <code>~/.venus</code> exists and you need to import a snapshot, you need to delete the <code>~/.venus/version</code> file first before importing the snapshot</strong></p></div> <div class="language- extra-class"><pre class="language-text"><code>The memory consumption of migration depends on the CPUs used. You can set the limit of CPU by environment variable (`VENUS_MIGRATION_MAX_WORKER_COUNT=n`), to avoid use out of memory.
Recommended value of `VENUS_MIGRATION_MAX_WORKER_COUNT`:

48G VENUS_MIGRATION_MAX_WORKER_COUNT=13
64G VENUS_MIGRATION_MAX_WORKER_COUNT=18
96G VENUS_MIGRATION_MAX_WORKER_COUNT=24

The migration of update 
</code></pre></div><ol><li><p>Check whether the vk file is complete after upgrading</p></li> <li><p>After the upgrade, execute the command <code>./venus state network-info</code>, and then check whether the <code>UpgradeWatermelonHeight</code> is normal through the log:</p> <div class="language- extra-class"><pre class="language-text"><code>#cali
UpgradeWatermelonHeight: 1013134
#mainnet
UpgradeWatermelonHeight: 3469380
</code></pre></div></li> <li><p>After the upgrade, you need to check whether the block height is synchronized normally.</p></li> <li><p>Check the mainnet <code>v12 actors</code> code and make sure it is the same as the output below</p> <div class="language- extra-class"><pre class="language-text"><code>./venus state actor-cids --network-version 21

# Ordering may be different
Network Version: 21
Actor Version: 12
Actor             CID
datacap           bafk2bzacebpiwb2ml4qbnnaayxumtk43ryhc63exdgnhivy3hwgmzemawsmpq
ethaccount        bafk2bzaceb4gkau2vgsijcxpfuq33bd7w3efr2rrhxrwiacjmns2ntdiamswq
reward            bafk2bzacealqnxn5lwzwexd6reav4dppypquklx2ujlnvaxiqk2tzstyvkp5u
verifiedregistry  bafk2bzacedudgflxc75c77c6zkmfyq4u2xuk7k6xw6dfdccarjrvxx453b77q
eam               bafk2bzaceb3elj4hfbbjp7g5bptc7su7mptszl4nlqfedilxvstjo5ungm6oe
multisig          bafk2bzacecw5lyp3n3t67xdwrmo36h4z7afc3lobmmr6wg55w6yjzg5jhmh42
storagemarket     bafk2bzacedylkg5am446lcuih4voyzdn4yjeqfsxfzh5b6mcuhx4mok5ph5c4
system            bafk2bzacebfqrja2hip7esf4eafxjmu6xcogoqu5xxtgdg7xa5szgvvdguchu
account           bafk2bzaceboftg75mdiba7xbo2i3uvgtca4brhnr3u5ptihonixgpnrvhpxoa
cron              bafk2bzacechxjkfe2cehx4s7skj3wzfpzf7zolds64khrrrs66bhazsemktls
placeholder       bafk2bzacedfvut2myeleyq67fljcrw4kkmn5pb5dpyozovj7jpoez5irnc3ro
storagepower      bafk2bzacecsij5tpfzjpfuckxvccv2p3bdqjklkrfyyoei6lx5dyj5j4fvjm6
evm               bafk2bzacecmnyfiwb52tkbwmm2dsd7ysi3nvuxl3lmspy7pl26wxj4zj7w4wi
init              bafk2bzacebllyegx5r6lggf6ymyetbp7amacwpuxakhtjvjtvoy2bfkzk3vms
paymentchannel    bafk2bzacectv4cm47bnhga5febf3lo3fq47g72kmmp2xd5s6tcxz7hiqdywa4
storageminer      bafk2bzacedo75pabe4i2l3hvhtsjmijrcytd2y76xwe573uku25fi7sugqld6
</code></pre></div></li> <li><p>If there is no problem troubleshoot, it is not recommended to set the rust log level to <code>trace</code> because more logs will be printed.</p></li> <li><p>After the upgrade, you can use the command <code>./venus state get-actor t01000</code> to confirm whether the upgrade is successful.</p></li> <li><p>actor migration</p></li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><strong>After testing, the pre-migration time is about 20 to 30 minutes, and the actual migration time is about 70 seconds</strong></p> <div class="language- extra-class"><pre><code> ```
 The pre-migration height is the 120 heights before the upgrade height:
 pre-migration start: STARTING pre-migration end: COMPLETED pre-migration
 migration starts: STARTING migration ends: COMPLETED migration
 ```
</code></pre></div></div> <h3 id="sophon-gateway"><a href="#sophon-gateway" class="header-anchor">#</a> sophon-gateway</h3> <p>Functions affected:</p> <ul><li>None</li></ul> <p>Dependency:</p> <ul><li>sophon-auth</li></ul> <p>Precautions:</p> <ul><li>When compiling, you need to first <code>make dist-clean</code> and then <code>make</code></li></ul> <h3 id="sophon-messager"><a href="#sophon-messager" class="header-anchor">#</a> sophon-messager</h3> <p>Affected functions:</p> <ul><li>None</li></ul> <p>Dependency:</p> <ul><li>venus</li> <li>sophon-auth</li> <li>sophon-gateway</li></ul> <p>Precautions:</p> <ul><li>After the upgrade, monitor whether the messages can be received normally and whether the messages can be  on-chained normally.</li></ul> <h3 id="sophon-miner"><a href="#sophon-miner" class="header-anchor">#</a> sophon-miner</h3> <p>Affect functions:</p> <p>Dependency:</p> <ul><li>auth</li> <li>venus</li> <li>gateway</li></ul> <p>Precautions:</p> <ul><li><code>[Auth].[Token]</code> in the configuration file must be configured, and the token must be created with admin permission from sophon-auth. It is recommended that one does not use the token from <code>defaultLocalToken</code>, one should create one manually.</li></ul> <h3 id="droplet"><a href="#droplet" class="header-anchor">#</a> Droplet</h3> <p>Affected functions:</p> <ul><li>Support v2 version of storage deal protocol</li> <li>Support offline computation of commP</li></ul> <p>Dependency:</p> <ul><li>auth</li> <li>venus</li> <li>gateway</li> <li>messager</li></ul> <p>Precautions:</p> <ul><li>Monitor deals and retrievals</li></ul> <h3 id="venus-wallet"><a href="#venus-wallet" class="header-anchor">#</a> venus-wallet</h3> <p>Affected functions:</p> <ul><li>None</li></ul> <p>Dependency:</p> <ul><li>gateway</li></ul> <p>Precautions:</p> <ul><li>After the upgrade, monitor whether the signature is normal and whether the message can be on-chained normally.</li></ul> <h3 id="damocles-manager"><a href="#damocles-manager" class="header-anchor">#</a> damocles-manager</h3> <p>Dependency:</p> <ul><li>Sophon service</li></ul> <p>Precautions:</p> <ul><li>When compiling, you need to first <code>make dist-clean</code> and then <code>make</code></li></ul> <h3 id="damocles-worker"><a href="#damocles-worker" class="header-anchor">#</a> damocles-worker</h3> <p>Dependency:</p> <ul><li>damocles-manager</li></ul> <p>Precautions:
Translation:</p> <ul><li>It is recommended to perform program updates after all tasks have been done and there are no ongoing tasks. If an update is required during the task on going, the sealing thread may get stuck in the 'SyntheticPoRepNeeded' state. In such cases, resetting the task status to 'PCSubmitted' can resolve the issue. You can use the following command: <code>damocles-manager util worker resume &lt;worker name&gt; &lt;thread index&gt; PCSubmitted</code>.</li> <li>The new proof type <code>SyntheticPoRep</code> uses a new proof parameter file. If <code>SyntheticPoRep</code> is enabled, it is best to prepare new proof parameters in advance. <strong>Failing to do so may cause SyntheticPoRep deadlock</strong>.</li></ul> <hr> <p>Upgrade result verification steps:</p> <ol><li>Check if program starts normally</li> <li>Check if Pre &amp; prove messages are on-chained normally</li> <li>Check if block producing is normal</li> <li>Check if window post is normal</li> <li>Check if storage power grows normally</li> <li>Check if storage deal retrieval is normal</li> <li>Check if various gas, life cycle, and aggregation settings of the database are normal.</li></ol> <h3 id="database-changes"><a href="#database-changes" class="header-anchor">#</a> Database changes</h3> <ol><li>Add <code>id</code> field to droplet <code>storage_deals</code> table  ==&gt; <code>ALTER TABLE storage_deals ADD id varchar(128)</code></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/filecoin-project/venus-docs/edit/master/docs/operation/nv21-upgrade.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/6/2024, 2:53:43 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/operation/nv22-upgrade.html" class="prev">
        nv22 upgrade
      </a></span> <span class="next"><a href="/operation/nv19-upgrade.html">
        nv19 upgrade
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cc17245a.js" defer></script><script src="/assets/js/2.0bbd4042.js" defer></script><script src="/assets/js/35.d6ee49fe.js" defer></script>
  </body>
</html>
