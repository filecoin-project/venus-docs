(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{422:function(e,t,a){"use strict";a.r(t);var o=a(17),s=Object(o.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"venus-nv21-upgrade-guide"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#venus-nv21-upgrade-guide"}},[e._v("#")]),e._v(" Venus nv21 Upgrade Guide")]),e._v(" "),a("h2",{attrs:{id:"precautions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#precautions"}},[e._v("#")]),e._v(" Precautions")]),e._v(" "),a("ol",[a("li",[e._v("Be sure to upgrade all Venus products")]),e._v(" "),a("li",[e._v("After upgrading, please use the "),a("code",[e._v("curl")]),e._v(" command to call the "),a("code",[e._v("Version")]),e._v(" API to check the version number. Details of each Venus products' version interface can be found "),a("a",{attrs:{href:"https://github.com/filecoin-project/venus/issues/5132",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("li",[e._v("Monitor proper on-chain of pre and prove messages")]),e._v(" "),a("li",[e._v("Monitor proper on-chain of window post messages")]),e._v(" "),a("li",[e._v("Monitor block producing")]),e._v(" "),a("li",[e._v("Check whether the gas fee related settings are in effect")])]),e._v(" "),a("h2",{attrs:{id:"products-upgrade-guide"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#products-upgrade-guide"}},[e._v("#")]),e._v(" Products Upgrade Guide")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Product")]),e._v(" "),a("th",[e._v("tag")]),e._v(" "),a("th",[e._v("commit")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("sophon-auth")]),e._v(" "),a("td",[e._v("v1.14.0")]),e._v(" "),a("td",[e._v("7caadbc")])]),e._v(" "),a("tr",[a("td",[e._v("venus")]),e._v(" "),a("td",[e._v("v1.14.2")]),e._v(" "),a("td",[e._v("9204048")])]),e._v(" "),a("tr",[a("td",[e._v("sophon-messager")]),e._v(" "),a("td",[e._v("v1.14.0")]),e._v(" "),a("td",[e._v("e5f8371")])]),e._v(" "),a("tr",[a("td",[e._v("soohon-gateway")]),e._v(" "),a("td",[e._v("v1.14.0")]),e._v(" "),a("td",[e._v("1adf038")])]),e._v(" "),a("tr",[a("td",[e._v("venus-wallet")]),e._v(" "),a("td",[e._v("v1.14.0")]),e._v(" "),a("td",[e._v("b478cd0")])]),e._v(" "),a("tr",[a("td",[e._v("sophon-miner")]),e._v(" "),a("td",[e._v("v1.14.0")]),e._v(" "),a("td",[e._v("9ca976c")])]),e._v(" "),a("tr",[a("td",[e._v("droplet")]),e._v(" "),a("td",[e._v("v2.10.0")]),e._v(" "),a("td",[e._v("6daf168")])]),e._v(" "),a("tr",[a("td",[e._v("damocles-manager")]),e._v(" "),a("td",[e._v("v0.9.2")]),e._v(" "),a("td",[e._v("f3c5400")])]),e._v(" "),a("tr",[a("td",[e._v("damocles-worker")]),e._v(" "),a("td",[e._v("v0.9.2")]),e._v(" "),a("td",[e._v("f3c5400")])])])]),e._v(" "),a("h3",{attrs:{id:"recommended-upgrade-sequence"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#recommended-upgrade-sequence"}},[e._v("#")]),e._v(" Recommended Upgrade Sequence")]),e._v(" "),a("ol",[a("li",[e._v("sophon-auth")]),e._v(" "),a("li",[e._v("venus")]),e._v(" "),a("li",[e._v("soohon-gateway")]),e._v(" "),a("li",[e._v("sophon-messager")]),e._v(" "),a("li",[e._v("sophon-miner")]),e._v(" "),a("li",[e._v("droplet")]),e._v(" "),a("li",[e._v("venus-wallet")]),e._v(" "),a("li",[e._v("damocles-manager\n9.damocles-worker")])]),e._v(" "),a("h3",{attrs:{id:"sophon-auth"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sophon-auth"}},[e._v("#")]),e._v(" sophon-auth")]),e._v(" "),a("p",[e._v("Affected functions:")]),e._v(" "),a("ul",[a("li",[e._v("Affecting how other Venus products are authorized to use the sophon service")])]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("None")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[e._v("Check if authentication is normal after startup")])]),e._v(" "),a("h3",{attrs:{id:"venus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#venus"}},[e._v("#")]),e._v(" venus")]),e._v(" "),a("p",[e._v("Affected functions:")]),e._v(" "),a("ul",[a("li",[e._v("None")])]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("sophon-auth")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),a("p",[e._v("Compile: First "),a("code",[e._v("make dist-clean")]),e._v(" and then "),a("code",[e._v("make")]),e._v(", this can prevent problems caused by failure to upgrade "),a("code",[e._v("filecoin-ffi")]),e._v(" properly")]),e._v(" "),a("p",[a("strong",[e._v("If "),a("code",[e._v("~/.venus")]),e._v(" exists and you need to import a snapshot, you need to delete the "),a("code",[e._v("~/.venus/version")]),e._v(" file first before importing the snapshot")])])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("The memory consumption of migration depends on the CPUs used. You can set the limit of CPU by environment variable (`VENUS_MIGRATION_MAX_WORKER_COUNT=n`), to avoid use out of memory.\nRecommended value of `VENUS_MIGRATION_MAX_WORKER_COUNT`:\n\n48G VENUS_MIGRATION_MAX_WORKER_COUNT=13\n64G VENUS_MIGRATION_MAX_WORKER_COUNT=18\n96G VENUS_MIGRATION_MAX_WORKER_COUNT=24\n\nThe migration of update \n")])])]),a("ol",[a("li",[a("p",[e._v("Check whether the vk file is complete after upgrading")])]),e._v(" "),a("li",[a("p",[e._v("After the upgrade, execute the command "),a("code",[e._v("./venus state network-info")]),e._v(", and then check whether the "),a("code",[e._v("UpgradeWatermelonHeight")]),e._v(" is normal through the log:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#cali\nUpgradeWatermelonHeight: 1013134\n#mainnet\nUpgradeWatermelonHeight: 3469380\n")])])])]),e._v(" "),a("li",[a("p",[e._v("After the upgrade, you need to check whether the block height is synchronized normally.")])]),e._v(" "),a("li",[a("p",[e._v("Check the mainnet "),a("code",[e._v("v12 actors")]),e._v(" code and make sure it is the same as the output below")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("./venus state actor-cids --network-version 21\n\n# Ordering may be different\nNetwork Version: 21\nActor Version: 12\nActor             CID\ndatacap           bafk2bzacebpiwb2ml4qbnnaayxumtk43ryhc63exdgnhivy3hwgmzemawsmpq\nethaccount        bafk2bzaceb4gkau2vgsijcxpfuq33bd7w3efr2rrhxrwiacjmns2ntdiamswq\nreward            bafk2bzacealqnxn5lwzwexd6reav4dppypquklx2ujlnvaxiqk2tzstyvkp5u\nverifiedregistry  bafk2bzacedudgflxc75c77c6zkmfyq4u2xuk7k6xw6dfdccarjrvxx453b77q\neam               bafk2bzaceb3elj4hfbbjp7g5bptc7su7mptszl4nlqfedilxvstjo5ungm6oe\nmultisig          bafk2bzacecw5lyp3n3t67xdwrmo36h4z7afc3lobmmr6wg55w6yjzg5jhmh42\nstoragemarket     bafk2bzacedylkg5am446lcuih4voyzdn4yjeqfsxfzh5b6mcuhx4mok5ph5c4\nsystem            bafk2bzacebfqrja2hip7esf4eafxjmu6xcogoqu5xxtgdg7xa5szgvvdguchu\naccount           bafk2bzaceboftg75mdiba7xbo2i3uvgtca4brhnr3u5ptihonixgpnrvhpxoa\ncron              bafk2bzacechxjkfe2cehx4s7skj3wzfpzf7zolds64khrrrs66bhazsemktls\nplaceholder       bafk2bzacedfvut2myeleyq67fljcrw4kkmn5pb5dpyozovj7jpoez5irnc3ro\nstoragepower      bafk2bzacecsij5tpfzjpfuckxvccv2p3bdqjklkrfyyoei6lx5dyj5j4fvjm6\nevm               bafk2bzacecmnyfiwb52tkbwmm2dsd7ysi3nvuxl3lmspy7pl26wxj4zj7w4wi\ninit              bafk2bzacebllyegx5r6lggf6ymyetbp7amacwpuxakhtjvjtvoy2bfkzk3vms\npaymentchannel    bafk2bzacectv4cm47bnhga5febf3lo3fq47g72kmmp2xd5s6tcxz7hiqdywa4\nstorageminer      bafk2bzacedo75pabe4i2l3hvhtsjmijrcytd2y76xwe573uku25fi7sugqld6\n")])])])]),e._v(" "),a("li",[a("p",[e._v("If there is no problem troubleshoot, it is not recommended to set the rust log level to "),a("code",[e._v("trace")]),e._v(" because more logs will be printed.")])]),e._v(" "),a("li",[a("p",[e._v("After the upgrade, you can use the command "),a("code",[e._v("./venus state get-actor t01000")]),e._v(" to confirm whether the upgrade is successful.")])]),e._v(" "),a("li",[a("p",[e._v("actor migration")])])]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),a("p",[a("strong",[e._v("After testing, the pre-migration time is about 20 to 30 minutes, and the actual migration time is about 70 seconds")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v(" ```\n The pre-migration height is the 120 heights before the upgrade height:\n pre-migration start: STARTING pre-migration end: COMPLETED pre-migration\n migration starts: STARTING migration ends: COMPLETED migration\n ```\n")])])])]),e._v(" "),a("h3",{attrs:{id:"sophon-gateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sophon-gateway"}},[e._v("#")]),e._v(" sophon-gateway")]),e._v(" "),a("p",[e._v("Functions affected:")]),e._v(" "),a("ul",[a("li",[e._v("None")])]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("sophon-auth")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[e._v("When compiling, you need to first "),a("code",[e._v("make dist-clean")]),e._v(" and then "),a("code",[e._v("make")])])]),e._v(" "),a("h3",{attrs:{id:"sophon-messager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sophon-messager"}},[e._v("#")]),e._v(" sophon-messager")]),e._v(" "),a("p",[e._v("Affected functions:")]),e._v(" "),a("ul",[a("li",[e._v("None")])]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("venus")]),e._v(" "),a("li",[e._v("sophon-auth")]),e._v(" "),a("li",[e._v("sophon-gateway")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[e._v("After the upgrade, monitor whether the messages can be received normally and whether the messages can be  on-chained normally.")])]),e._v(" "),a("h3",{attrs:{id:"sophon-miner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sophon-miner"}},[e._v("#")]),e._v(" sophon-miner")]),e._v(" "),a("p",[e._v("Affect functions:")]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("auth")]),e._v(" "),a("li",[e._v("venus")]),e._v(" "),a("li",[e._v("gateway")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("[Auth].[Token]")]),e._v(" in the configuration file must be configured, and the token must be created with admin permission from sophon-auth. It is recommended that one does not use the token from "),a("code",[e._v("defaultLocalToken")]),e._v(", one should create one manually.")])]),e._v(" "),a("h3",{attrs:{id:"droplet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#droplet"}},[e._v("#")]),e._v(" Droplet")]),e._v(" "),a("p",[e._v("Affected functions:")]),e._v(" "),a("ul",[a("li",[e._v("Support v2 version of storage deal protocol")]),e._v(" "),a("li",[e._v("Support offline computation of commP")])]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("auth")]),e._v(" "),a("li",[e._v("venus")]),e._v(" "),a("li",[e._v("gateway")]),e._v(" "),a("li",[e._v("messager")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[e._v("Monitor deals and retrievals")])]),e._v(" "),a("h3",{attrs:{id:"venus-wallet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#venus-wallet"}},[e._v("#")]),e._v(" venus-wallet")]),e._v(" "),a("p",[e._v("Affected functions:")]),e._v(" "),a("ul",[a("li",[e._v("None")])]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("gateway")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[e._v("After the upgrade, monitor whether the signature is normal and whether the message can be on-chained normally.")])]),e._v(" "),a("h3",{attrs:{id:"damocles-manager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#damocles-manager"}},[e._v("#")]),e._v(" damocles-manager")]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("Sophon service")])]),e._v(" "),a("p",[e._v("Precautions:")]),e._v(" "),a("ul",[a("li",[e._v("When compiling, you need to first "),a("code",[e._v("make dist-clean")]),e._v(" and then "),a("code",[e._v("make")])])]),e._v(" "),a("h3",{attrs:{id:"damocles-worker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#damocles-worker"}},[e._v("#")]),e._v(" damocles-worker")]),e._v(" "),a("p",[e._v("Dependency:")]),e._v(" "),a("ul",[a("li",[e._v("damocles-manager")])]),e._v(" "),a("p",[e._v("Precautions:\nTranslation:")]),e._v(" "),a("ul",[a("li",[e._v("It is recommended to perform program updates after all tasks have been done and there are no ongoing tasks. If an update is required during the task on going, the sealing thread may get stuck in the 'SyntheticPoRepNeeded' state. In such cases, resetting the task status to 'PCSubmitted' can resolve the issue. You can use the following command: "),a("code",[e._v("damocles-manager util worker resume <worker name> <thread index> PCSubmitted")]),e._v(".")]),e._v(" "),a("li",[e._v("The new proof type "),a("code",[e._v("SyntheticPoRep")]),e._v(" uses a new proof parameter file. If "),a("code",[e._v("SyntheticPoRep")]),e._v(" is enabled, it is best to prepare new proof parameters in advance. "),a("strong",[e._v("Failing to do so may cause SyntheticPoRep deadlock")]),e._v(".")])]),e._v(" "),a("hr"),e._v(" "),a("p",[e._v("Upgrade result verification steps:")]),e._v(" "),a("ol",[a("li",[e._v("Check if program starts normally")]),e._v(" "),a("li",[e._v("Check if Pre & prove messages are on-chained normally")]),e._v(" "),a("li",[e._v("Check if block producing is normal")]),e._v(" "),a("li",[e._v("Check if window post is normal")]),e._v(" "),a("li",[e._v("Check if storage power grows normally")]),e._v(" "),a("li",[e._v("Check if storage deal retrieval is normal")]),e._v(" "),a("li",[e._v("Check if various gas, life cycle, and aggregation settings of the database are normal.")])]),e._v(" "),a("h3",{attrs:{id:"database-changes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#database-changes"}},[e._v("#")]),e._v(" Database changes")]),e._v(" "),a("ol",[a("li",[e._v("Add "),a("code",[e._v("id")]),e._v(" field to droplet "),a("code",[e._v("storage_deals")]),e._v(" table  ==> "),a("code",[e._v("ALTER TABLE storage_deals ADD id varchar(128)")])])])])}),[],!1,null,null,null);t.default=s.exports}}]);