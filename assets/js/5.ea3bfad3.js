(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{381:function(t,s,a){t.exports=a.p+"assets/img/20221013153319.ecc30903.png"},382:function(t,s,a){t.exports=a.p+"assets/img/20221013143419.5869a3ac.png"},383:function(t,s,a){t.exports=a.p+"assets/img/20221021131654.aa3341a6.png"},384:function(t,s,a){t.exports=a.p+"assets/img/20221013231224.6582cf38.png"},551:function(t,s,a){"use strict";a.r(s);var n=a(17),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"boost-新增协议兼容性调研"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boost-新增协议兼容性调研"}},[t._v("#")]),t._v(" boost 新增协议兼容性调研")]),t._v(" "),n("h2",{attrs:{id:"结论"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[t._v("#")]),t._v(" 结论")]),t._v(" "),n("ol",[n("li",[t._v("boost 在协议层补充了两个新的协议 (细节见后文)\n"),n("ol",[n("li",[n("code",[t._v("/fil/storage/mk/1.2.0")])]),t._v(" "),n("li",[n("code",[t._v("/fil/storage/status/1.2.0")])])])]),t._v(" "),n("li",[t._v("新协议的提出主要改进了 client 到 market 的数据传输,并不会对 venus-market 多矿工的架构造成影响")]),t._v(" "),n("li",[t._v("现在的 venus-market 可以比较顺滑地升级以支持新的协议")])]),t._v(" "),n("h2",{attrs:{id:"协议变化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#协议变化"}},[t._v("#")]),t._v(" 协议变化")]),t._v(" "),n("p",[t._v("boost 在兼容以前协议的基础上,新增了两种协议:")]),t._v(" "),n("ul",[n("li",[t._v("向 market 推送订单的协议: "),n("code",[t._v("/fil/storage/mk/1.2.0")])]),t._v(" "),n("li",[t._v("以及查询订单数据: "),n("code",[t._v("/fil/storage/status/1.2.0")])])]),t._v(" "),n("h3",{attrs:{id:"fil-storage-mk-1-2-0"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fil-storage-mk-1-2-0"}},[t._v("#")]),t._v(" "),n("code",[t._v("/fil/storage/mk/1.2.0")])]),t._v(" "),n("h4",{attrs:{id:"request"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#request"}},[t._v("#")]),t._v(" Request")]),t._v(" "),n("h5",{attrs:{id:"描述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#描述"}},[t._v("#")]),t._v(" 描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("Field")]),t._v(" "),n("th",[t._v("Type")]),t._v(" "),n("th",[t._v("Description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("DealUUID")]),t._v(" "),n("td",[t._v("uuid")]),t._v(" "),n("td",[t._v('gen by client with uuid ("github.com/google/uuid")')])]),t._v(" "),n("tr",[n("td",[t._v("IsOffline")]),t._v(" "),n("td",[t._v("boolean")]),t._v(" "),n("td",[t._v("Indicates whether the deal is online or offline")])]),t._v(" "),n("tr",[n("td",[t._v("ClientDealProposal")]),t._v(" "),n("td",[t._v("ClientDealProposal")]),t._v(" "),n("td",[t._v("Same as "),n("code",[t._v("<v1 proposal>.DealProposal")])])]),t._v(" "),n("tr",[n("td",[t._v("DealDataRoot")]),t._v(" "),n("td",[t._v("cid")]),t._v(" "),n("td",[t._v("The root cid of the CAR file. Same as "),n("code",[t._v("<v1 proposal>.Piece.Root")])])]),t._v(" "),n("tr",[n("td",[t._v("Transfer")]),t._v(" "),n("td",[t._v("struct")]),t._v(" "),n("td",[t._v("Transfer has the parameters for a data transfer")])])])]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" DealParams "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tDealUUID           uuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UUID\n\tIsOffline          "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\tClientDealProposal market"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ClientDealProposal\n\tDealDataRoot       cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cid\n\tTransfer           Transfer "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Transfer params will be the zero value if this is an offline deal")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Transfer has the parameters for a data transfer")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Transfer "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// The type of transfer eg "http"')]),t._v("\n\tType "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// An optional ID that can be supplied by the client to identify the deal")]),t._v("\n\tClientID "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// A byte array containing marshalled data specific to the transfer type")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// eg a JSON encoded struct { URL: "<url>", Headers: {...} }')]),t._v("\n\tParams "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The size of the data transferred in bytes")]),t._v("\n\tSize "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("目前 boost 中只支持 http 类型的 transfer")]),t._v(" "),n("h4",{attrs:{id:"response"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#response"}},[t._v("#")]),t._v(" Response")]),t._v(" "),n("h5",{attrs:{id:"描述-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#描述-2"}},[t._v("#")]),t._v(" 描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("Field")]),t._v(" "),n("th",[t._v("Type")]),t._v(" "),n("th",[t._v("Description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("Accepted")]),t._v(" "),n("td",[t._v("boolean")]),t._v(" "),n("td",[t._v("Indicates whether the deal proposal was accepted")])]),t._v(" "),n("tr",[n("td",[t._v("Message")]),t._v(" "),n("td",[t._v("string")]),t._v(" "),n("td",[t._v("A message about why the deal proposal was rejected")])])])]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" DealResponse "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tAccepted "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Message is the reason the deal proposal was rejected. It is empty if")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the deal was accepted.")]),t._v("\n\tMessage "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"fil-storage-status-1-2-0"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fil-storage-status-1-2-0"}},[t._v("#")]),t._v(" "),n("code",[t._v("/fil/storage/status/1.2.0")])]),t._v(" "),n("h3",{attrs:{id:"request-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#request-2"}},[t._v("#")]),t._v(" Request")]),t._v(" "),n("h5",{attrs:{id:"描述-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#描述-3"}},[t._v("#")]),t._v(" 描述")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("Field")]),t._v(" "),n("th",[t._v("Type")]),t._v(" "),n("th",[t._v("Description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("DealUUID")]),t._v(" "),n("td",[t._v("uuid")]),t._v(" "),n("td",[t._v("The uuid of the deal")])]),t._v(" "),n("tr",[n("td",[t._v("Signature")]),t._v(" "),n("td",[n("a",{attrs:{href:"https://github.com/filecoin-project/go-state-types/blob/057cdfb837f7a0309c1607c7c4640f315e51d7af/crypto/signature.go#L36-L39",target:"_blank",rel:"noopener noreferrer"}},[t._v("Signature"),n("OutboundLink")],1)]),t._v(" "),n("td",[t._v("A signature over the uuid with the client's wallet")])])])]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// DealStatusRequest is sent to get the current state of a deal from a")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// storage provider")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" DealStatusRequest "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tDealUUID  uuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UUID\n\tSignature crypto"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Signature\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"response-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#response-2"}},[t._v("#")]),t._v(" Response")]),t._v(" "),n("h5",{attrs:{id:"相关源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#相关源码"}},[t._v("#")]),t._v(" 相关源码")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("Field")]),t._v(" "),n("th",[t._v("Type")]),t._v(" "),n("th",[t._v("Description")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("DealUUID")]),t._v(" "),n("td",[t._v("uuid")]),t._v(" "),n("td",[t._v("The uuid of the deal")])]),t._v(" "),n("tr",[n("td",[t._v("Error")]),t._v(" "),n("td",[t._v("string")]),t._v(" "),n("td",[t._v("Non-empty if there's an error getting the deal status")])]),t._v(" "),n("tr",[n("td",[t._v("IsOffline")]),t._v(" "),n("td",[t._v("boolean")]),t._v(" "),n("td",[t._v("Indicates whether the deal is online or offline")])]),t._v(" "),n("tr",[n("td",[t._v("TransferSize")]),t._v(" "),n("td",[t._v("integer")]),t._v(" "),n("td",[t._v("The total size of the transfer in bytes")])]),t._v(" "),n("tr",[n("td",[t._v("NBytesReceived")]),t._v(" "),n("td",[t._v("integer")]),t._v(" "),n("td",[t._v("The number of bytes that have been downloaded")])]),t._v(" "),n("tr",[n("td",[t._v("DealStatus")]),t._v(" "),n("td",[t._v("struct")]),t._v(" "),n("td",[t._v("the status of deal")])]),t._v(" "),n("tr",[n("td",[t._v("SignedProposalCid")]),t._v(" "),n("td",[t._v("cid")]),t._v(" "),n("td",[t._v("cid of the client deal proposal + signature")])]),t._v(" "),n("tr",[n("td",[t._v("PublishCid")]),t._v(" "),n("td",[t._v("cid")]),t._v(" "),n("td",[t._v("The cid of the publish message, if the deal has been published")])]),t._v(" "),n("tr",[n("td",[t._v("ChainDealID")]),t._v(" "),n("td",[t._v("integer")]),t._v(" "),n("td",[t._v("The ID of the deal on chain, if it's been published")])])])]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// DealStatusResponse is the current state of a deal")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" DealStatusResponse "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tDealUUID uuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UUID\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Error is non-empty if there is an error getting the deal status")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// (eg invalid request signature)")]),t._v("\n\tError          "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\tDealStatus     "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("DealStatus\n\tIsOffline      "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\tTransferSize   "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\tNBytesReceived "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" DealStatus "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Error is non-empty if the deal is in the error state")]),t._v("\n\tError "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Status is a string corresponding to a deal checkpoint")]),t._v("\n\tStatus "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// SealingStatus is the sealing status reported by lotus miner")]),t._v("\n\tSealingStatus "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Proposal is the deal proposal")]),t._v("\n\tProposal market"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealProposal\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// SignedProposalCid is the cid of the client deal proposal + signature")]),t._v("\n\tSignedProposalCid cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cid\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// PublishCid is the cid of the Publish message sent on chain, if the deal")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// has reached the publish stage")]),t._v("\n\tPublishCid "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cid\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ChainDealID is the id of the deal in chain state")]),t._v("\n\tChainDealID abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealID\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// status")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\tAccepted Checkpoint "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("iota")]),t._v("\n\tTransferred\n\tPublished\n\tPublishConfirmed\n\tAddedPiece\n\tIndexedAndAnnounced\n\tComplete\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" names "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Checkpoint"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tAccepted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Accepted"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tTransferred"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("         "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Transferred"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tPublished"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("           "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Published"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tPublishConfirmed"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PublishConfirmed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tAddedPiece"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("          "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"AddedPiece"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tIndexedAndAnnounced"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"IndexedAndAnnounced"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tComplete"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Complete"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// SealingStatus string类型,没看到所有的枚举定义")]),t._v("\n\n")])])]),n("h2",{attrs:{id:"boost-的相关实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boost-的相关实现"}},[t._v("#")]),t._v(" boost 的相关实现")]),t._v(" "),n("h4",{attrs:{id:"发起存储订单的流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发起存储订单的流程"}},[t._v("#")]),t._v(" 发起存储订单的流程")]),t._v(" "),n("h5",{attrs:{id:"对比之前的订单发起流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#对比之前的订单发起流程"}},[t._v("#")]),t._v(" 对比之前的订单发起流程")]),t._v(" "),n("p",[t._v("boost 实现的新的订单发起流程主要是基于 "),n("code",[t._v("/fil/storage/mk/1.2.0")]),t._v(" 拓展了 client 向 market 传输数据的方式(目前 boost 只实现了 http 的形式),舍弃了原本的"),n("code",[t._v("graphsync")]),t._v(",同时也简化了协商的流程")]),t._v(" "),n("h6",{attrs:{id:"两者的时序图"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#两者的时序图"}},[t._v("#")]),t._v(" 两者的时序图")]),t._v(" "),n("ul",[n("li",[t._v("传统的的订单发起流程 (基于 /fil/storage/mk/1.0.1 , /fil/storage/mk/1.1.0 /fil/storage/mk/1.1.1 )")])]),t._v(" "),n("img",{attrs:{src:a(381),width:"800"}}),t._v(" "),n("ul",[n("li",[t._v("boost 提出的新的订单发起流程 (基于 /fil/storage/mk/1.2.0 )")])]),t._v(" "),n("img",{attrs:{src:a(382),width:"800"}}),t._v(" "),n("h5",{attrs:{id:"相关源码-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#相关源码-2"}},[t._v("#")]),t._v(" 相关源码")]),t._v(" "),n("p",[t._v("线上订单时,client 根据 cli-flag 生成 types.Transfer (离线订单时该对象为空)")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Store the path to the CAR file as a transfer parameter")]),t._v("\ntransferParams "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("types2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HttpRequest"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("URL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http-url"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" cctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsSet")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http-headers"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\ttransferParams"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Headers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" cctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("StringSlice")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http-headers"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tsp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" strings"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Split")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("header"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"="')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"malformed http header: %s"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\ttransferParams"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Headers"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nparamsBytes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" json"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Marshal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transferParams"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"marshalling request parameters: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ntransfer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http"')]),t._v("\ntransfer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Params "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" paramsBytes\n\n")])])]),n("p",[t._v("准备发起订单的请求参数")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Create a deal proposal to storage provider using deal protocol v1.2.0 format")]),t._v("\ndealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("dealProposal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" walletAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootCid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("PaddedPieceSize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pieceSize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pieceCid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" maddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"duration"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Bool")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verified"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" providerCollateral"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTokenAmount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"storage-price"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to create a deal proposal: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\ndealParams "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" types"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealParams"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tDealUUID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("           dealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tClientDealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("dealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tDealDataRoot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("       rootCid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tIsOffline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("isOnline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tTransfer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("           transfer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("dealProposal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("clinode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" clientAddr address"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Address"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootCid cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pieceSize abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PaddedPieceSize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pieceCid cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" minerAddr address"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Address"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startEpoch abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ChainEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" duration "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" verified "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" providerCollateral abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TokenAmount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" storagePrice abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TokenAmount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("market"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ClientDealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tendEpoch "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" startEpoch "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ChainEpoch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("duration"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// deal proposal expects total storage price for deal per epoch, therefore we")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// multiply pieceSize * storagePrice (which is set per epoch per GiB) and divide by 2^30")]),t._v("\n\tstoragePricePerEpochForDeal "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" big"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("big"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Mul")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("big"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewInt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pieceSize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" storagePrice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" big"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewInt")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("int64")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" market"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewLabelFromString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rootCid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tproposal "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" market"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tPieceCID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("             pieceCid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tPieceSize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            pieceSize"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tVerifiedDeal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("         verified"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tClient"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("               clientAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tProvider"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("             minerAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tLabel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("                l"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tStartEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("           startEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tEndEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("             endEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tStoragePricePerEpoch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" storagePricePerEpochForDeal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tProviderCollateral"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("   providerCollateral"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tbuf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cborutil"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Dump")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("proposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tsig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Wallet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("WalletSign")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" clientAddr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" buf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" api"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MsgMeta"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Type"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MTDealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wallet sign failed: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("market"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ClientDealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("        proposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tClientSignature"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("client 发送订单请求")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Host"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewStream")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" addrInfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DealProtocolv120"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" cborutil"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteCborRPC")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("dealParams"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\terrc "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to send request: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("boost 接收到订单后,会先进行两步处理")]),t._v(" "),n("ol",[n("li",[t._v("校验订单的参数\n"),n("ul",[n("li",[t._v("校验的参数包括: PieceCID,signature,Provider,piece size,duration,epoch,provider collateral,ask,client fun 等等")])])]),t._v(" "),n("li",[t._v("将订单注入到 boost 的订单处理循环")])]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ExecuteDeal is called when the Storage Provider receives a deal proposal")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// from the network")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Provider"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("ExecuteDeal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealParams"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" clientPeer peer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("api"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProviderDealRejectionInfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" span "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" tracing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Tracer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Provider.ExecuteDeal"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" span"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("End")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tspan"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetAttributes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attribute"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dealUuid"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUUID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Example of adding additional attributes")]),t._v("\n\n\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUUID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"executing deal proposal received from network"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"peer"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" clientPeer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tds "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" types"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProviderDealState"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tDealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("           dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUUID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tClientDealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ClientDealProposal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tClientPeerID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("       clientPeer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tDealDataRoot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("       dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealDataRoot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tTransfer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("           dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transfer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tIsOffline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("          dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IsOffline"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tRetry"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("              smtypes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealRetryAuto"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// validate the deal proposal (校验订单数据)")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("validateDealProposal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\treason "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reason\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" reason "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\treason "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUUID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal proposal failed validation"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"reason"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reason"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("api"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProviderDealRejectionInfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tReason"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sprintf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed validation: %s"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reason"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将订单注入 订单处理循环")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("executeDeal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ds"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h4",{attrs:{id:"订单的处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#订单的处理"}},[t._v("#")]),t._v(" 订单的处理")]),t._v(" "),n("h5",{attrs:{id:"订单处理循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#订单处理循环"}},[t._v("#")]),t._v(" 订单处理循环")]),t._v(" "),n("p",[t._v("本小结简要介绍 boost 中订单处理循环 的处理流程\n该订单处理循环是个典型的 select-case 结构\n每个 case 对应一个 channel 作为循环的入口")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// channels used to pass messages to run loop")]),t._v("\n\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接入达成 dealcheckpoints.AddedPiece 状态之前的订单")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 会处理订单直到订单达成 dealcheckpoints.AddedPiece")]),t._v("\n\tacceptDealChan       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" acceptDealReq\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接入达成 dealcheckpoints.Published 的订单的")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 释放占用的 fund 资源")]),t._v("\n\tpublishedDealChan    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" publishDealReq\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接入 addpiece 之后的订单")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 释放被占用的 storage space 资源")]),t._v("\n\tstorageSpaceChan     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" storageSpaceDealReq\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接入需要清理资源占用的的订单 (完成的订单,或者失败的订单)")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 清理订单的资源占用,主要是 fund 和 storage space")]),t._v("\n\tfinishedDealChan     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" finishedDealReq\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接入希望重启或者希望终止 的已经停止的订单")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重启或者终止一个停止了的订单")]),t._v("\n\tupdateRetryStateChan "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" updateRetryStateReq\n")])])]),n("p",[t._v("注释:")]),t._v(" "),n("ul",[n("li",[t._v("fund 资源:\nboost 用于抵押的资金,在 deal 初始化时被分配, deal 发布之后,被分配的资金会作为抵押被转走,同时也应该释放相应 deal 的资金占用")]),t._v(" "),n("li",[t._v("storage 资源:\nboost 用于存储订单数据的存储空间资源,在订单创建时会被分配,在订单被 addpiece 之后会被释放掉")])]),t._v(" "),n("h5",{attrs:{id:"acceptdealchan-分支"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#acceptdealchan-分支"}},[t._v("#")]),t._v(" acceptDealChan 分支")]),t._v(" "),n("p",[t._v("五个 case 之中,会着重介绍 acceptDealChan 所在的 case 分支")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// case  <-p.acceptDealChan 的部分源码")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Process a request to")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// - accept a deal proposal and execute it immediately")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// - accept an offline deal proposal and save it for execution later")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   when the data is imported")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// - accept a request to import data for an offline deal")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" dealReq "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("acceptDealChan"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\tdeal "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" dealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deal\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"processing deal acceptance request"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 离线订单,预处理,等待数据导入")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IsOffline "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("dealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isImport "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// When the client proposes an offline deal, save the deal")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// to the database but don't execute the deal. The deal")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// will be executed when the Storage Provider imports the")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// deal data.")]),t._v("\n\t\t\tdh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkAndInsertDealHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.检查订单不重复")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.初始化订单,将之保存到数据库")]),t._v("\n\t\t\taerr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processOfflineDealProposal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The deal proposal was successful. Send an Accept response to the client.")]),t._v("\n\t\t\tdealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rsp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" acceptDealResp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("ri"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("api"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProviderDealRejectionInfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Accepted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Don't execute the deal now, wait for data import.")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 分配 fund 和 storage space 资源")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 初始化订单参数,包括订单数据的路径,创建订单的时间记录等")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IsOffline "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 离线订单,并且订单数据已经导入")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The Storage Provider is importing offline deal data, so tag")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// funds for the deal and execute it")]),t._v("\n\t\t\taerr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processImportOfflineDealData")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在线订单")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Process a regular deal proposal")]),t._v("\n\t\t\taerr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("processDealProposal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" aerr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendErrorResp")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("aerr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// set up deal handler so that clients can subscribe to deal update events")]),t._v("\n\t\tdh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkAndInsertDealHandler")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendErrorResp")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("acceptError"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" isSevereError"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reason"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server error: starting deal thread"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// start executing the deal")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("startDealThread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendErrorResp")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("acceptError"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" isSevereError"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reason"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server error: starting deal thread"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// send an accept response")]),t._v("\n\t\tdealReq"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rsp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" acceptDealResp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("api"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProviderDealRejectionInfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Accepted"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("在线订单会在完成订单资源分配和参数初始化之后,就会真正地开始执行订单处理线程\n离线订单会两次进入这一段代码,第一次初始化订单参数之后退出,当导入离线数据的时候会再次进入这段代码,进行资源分配并开始 叮当处理线程")]),t._v(" "),n("h5",{attrs:{id:"订单处理线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#订单处理线程"}},[t._v("#")]),t._v(" 订单处理线程")]),t._v(" "),n("p",[t._v("简要流程")]),t._v(" "),n("img",{attrs:{src:a(383),width:"800"}}),t._v(" "),n("p",[t._v("相关源码")]),t._v(" "),n("div",{staticClass:"language-go extra-class"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("p "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Provider"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("execDealUptoAddPiece")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProviderDealState"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dh "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("dealHandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("dealMakingError "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tpub "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" dh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Publisher\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// publish "new deal" event')]),t._v("\n\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fireEventDealNew")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// publish an event with the current state of the deal")]),t._v("\n\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("fireEventDealUpdate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal execution in progress"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Transfer Data step will be executed only if it's NOT an offline deal")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IsOffline "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Checkpoint "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" dealcheckpoints"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transferred "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Check that the deal's start epoch hasn't already elapsed")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" derr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkDealProposalStartEpoch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" derr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" derr\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// download data from the client,and verifyCommP")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("transferAndVerify")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The transfer has failed. If the user tries to cancel the")]),t._v("\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// transfer after this point it's a no-op.")]),t._v("\n\t\t\t\tdh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCancelTransferResponse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal data transfer finished successfully"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal data transfer has already been completed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// transfer can no longer be cancelled")]),t._v("\n\t\tdh"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCancelTransferResponse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("errors"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("New")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transfer already complete"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal data-transfer can no longer be cancelled"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Checkpoint "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" dealcheckpoints"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transferred "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// verify CommP matches for an offline deal")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("verifyCommP")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\terr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"error when matching commP for imported data for offline deal: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commp matched successfully for imported data for offline deal"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// update checkpoint")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" derr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateCheckpoint")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dealcheckpoints"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transferred"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" derr "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" derr\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Publish")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Checkpoint "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" dealcheckpoints"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Published "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("publishDeal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal successfully published and confirmed-publish"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal has already been published and confirmed-publish"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Now that the deal has been published, we no longer need to have funds")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// tagged as being for this deal (the publish message moves collateral")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// from the storage market actor escrow balance to the locked balance)")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("untagFundsAfterPublish")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If there's an error untagging funds we should still try to continue,")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// so just log the error")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Warnw")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to untag funds after sending publish message"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"funds successfully untagged for deal after publish"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// AddPiece")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Checkpoint "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" dealcheckpoints"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AddedPiece "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("addPiece")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\terr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to add piece: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal successfully handed over to the sealing subsystem"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal has already been handed over to the sealing subsystem"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// as deal has already been handed to the sealer, we can remove the inbound file and reclaim the tagged space")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IsOffline "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Remove")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("InboundFilePath"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"removed inbound file as deal handed to sealer"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"path"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("InboundFilePath"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("untagStorageSpaceAfterSealing")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If there's an error untagging storage space we should still try to continue,")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// so just log the error")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Warnw")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to untag storage space after handing deal to sealer"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"storage space successfully untagged for deal after it was handed to sealer"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Index deal in DAGStore and Announce deal")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Checkpoint "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" dealcheckpoints"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IndexedAndAnnounced "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("indexAndAnnounce")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\terr"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to add index and announce deal: %w"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal successfully indexed and announced"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dealLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("deal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DealUuid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deal has already been indexed and announced"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h4",{attrs:{id:"订单分配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#订单分配"}},[t._v("#")]),t._v(" 订单分配")]),t._v(" "),n("p",[t._v("在订单的处理流程中, addpiece 阶段会将订单数据分配到矿工的扇区.\n这个过程主要是通过调用 PieceAdder 接口的 AddPiece 方法来实现.\n其中 PieceAdder 主要底层是由 lotus-miner 的 rpc client 来实现的,其依赖路径如下")]),t._v(" "),n("img",{attrs:{src:a(384),width:"800"}})])}),[],!1,null,null,null);s.default=e.exports}}]);